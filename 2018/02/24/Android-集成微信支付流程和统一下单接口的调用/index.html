<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>阿龙的故事</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com"><span>Github</span></a></li><li><a href="https://www.v2ex.com/"><span>V2EX</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://www.hecl.club/images/content_bg.jpg"><div class="post-title"><h1 class="title">随笔</h1><ul class="meta"><li><i class="icon icon-author"></i>阿龙</li><li><i class="icon icon-clock"></i>31 Minutes</li><li><i class="icon icon-calendar"></i>2018年2月24日</li></ul></div></div><div class="article-content" style="max-width:800px"><pre><code>首先需要在 [微信的开放平台](https://open.weixin.qq.com/cgi-bin/index?t=home/index&amp;lang=zh_CN)注册一个账号，[注册流程详见](https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=open1419317780&amp;token=&amp;lang=zh_CN)。注意注册填写的邮箱，以后申请支付成功后，商户号、登录密码、API密钥等信息会发送到该邮箱，当有了微信的开放平台的账号后，就可以在管理中心创建应用，应用创建后需要七个工作日的审核，审核成功后，就可以申请该应用的微信支付了，设置android和ios的签名。（开通微信支付需要缴纳300元）。
**微信支付申请成功后，就可以调用微信支付的[统一下单](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_1)接口，统一下单接口接口请求参数是xml方式请求，返回的参数也是xml，这个需要注意，具体实现如下：
</code></pre><p>   <strong><strong> 首先是统一下单的参数设置（参数添加是按照ASCII码从小到大排序（字典序），因为在签名时候需要这个顺序）</strong></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*这里说一下为什么用LinkedHashMap，没有用HashMap。因为HashMap存储兼*键值对是无序的，LinkedHashMap输出的顺序和输入的相同，在签名的时候，需要map中储存的顺序。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">setPlaceOrderParameter</span><span class="params">(String tradeType)</span> </span>&#123;</span><br><span class="line">		Map&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">		map.put(<span class="string">"appid"</span>, <span class="string">"wx2c3865766f57ccb0"</span>);<span class="comment">// 微信支付分配的公众账号ID（企业号corpid即为此appId）</span></span><br><span class="line">		map.put(<span class="string">"attach"</span>, <span class="string">"支付测试"</span>);<span class="comment">// 附加数据，在查询API和支付通知中原样返回，可作为自定义参数使用。</span></span><br><span class="line">		map.put(<span class="string">"body"</span>, <span class="string">"JSAPI支付测试"</span>);<span class="comment">// 商品简单描述，该字段请按照规范传递</span></span><br><span class="line">		map.put(<span class="string">"mch_id"</span>, <span class="string">"1344819501"</span>);<span class="comment">// 微信支付分配的商户号</span></span><br><span class="line">		map.put(<span class="string">"nonce_str"</span>, genNonceStr());<span class="comment">// 随机字符串，长度要求在32位以内。推荐随机数生成算法</span></span><br><span class="line">											<span class="comment">// 1add1a30ac87aa2db72f57a2375d8fec</span></span><br><span class="line">		map.put(<span class="string">"notify_url"</span>, <span class="string">"http://wxpay.wxutil.com/pub_v2/pay/notify.v2.php"</span>);<span class="comment">// 异步接收微信支付结果通知的回调地址，通知url必须为外网可访问的url，不能携带参数。</span></span><br><span class="line"><span class="comment">//		map.put("openid", "oUpF8uMuAJO_M2pxb1Q9zNjWeS6o");// trade_type=JSAPI时（即公众号支付），此参数必传，此参数为微信用户在商户对应appid下的唯一标识https://pay.weixin.qq.com/wiki/doc/api/wap.php?chapter=4_4</span></span><br><span class="line">															<span class="comment">// 获取的地址</span></span><br><span class="line">		map.put(<span class="string">"out_trade_no"</span>, genOutTradNo());<span class="comment">// 商户系统内部订单号，要求32个字符内、且在同一个商户号下唯一</span></span><br><span class="line">		map.put(<span class="string">"spbill_create_ip"</span>, <span class="string">"127.0.0.1"</span>);<span class="comment">// APP和网页支付提交用户端ip，Native支付填调用微信支付API的机器IP</span></span><br><span class="line">		map.put(<span class="string">"total_fee"</span>, <span class="string">"100"</span>);<span class="comment">// 订单总金额，单位为分</span></span><br><span class="line">		map.put(<span class="string">"trade_type"</span>, tradeType);<span class="comment">// 取值如下：JSAPI，NATIVE，APP，MWEB等</span></span><br><span class="line"></span><br><span class="line">		String sign = getSign(map);</span><br><span class="line">		map.put(<span class="string">"sign"</span>, sign);<span class="comment">// 通过签名算法计算得出的签名值</span></span><br><span class="line"></span><br><span class="line">		String xmlstring = toXml(map);</span><br><span class="line">		<span class="keyword">return</span> xmlstring;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p> <strong><strong> 代码注解很详细就不多记录了，下面是签名算法</strong></strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 通过签名算法计算得出的签名值</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getSign</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : map.entrySet()) &#123;</span><br><span class="line">			sb.append(entry.getKey());</span><br><span class="line">			sb.append(<span class="string">'='</span>);</span><br><span class="line">			sb.append(entry.getValue());</span><br><span class="line">			sb.append(<span class="string">'&amp;'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 拼接API密钥</span></span><br><span class="line">		sb.append(<span class="string">"key="</span>);</span><br><span class="line">		sb.append(<span class="string">"UrS7zXfUTf5Pq7s8l0WpP7MvQyQRIhPN"</span>);</span><br><span class="line">		System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;signsb&gt;"</span> + sb.toString());</span><br><span class="line">		String packageSign = MD5.getMessageDigest(sb.toString().getBytes()).toUpperCase(Locale.CHINA);</span><br><span class="line">		System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;sign&gt;"</span> + packageSign);</span><br><span class="line">		<span class="keyword">return</span> packageSign;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong><strong>下面代码是吧参数变成xml格式的字符串</strong></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 拼接成xml形式的字符串，以供统一下单使用</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">toXml</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		sb.append(<span class="string">"&lt;xml&gt;"</span>);</span><br><span class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : map.entrySet()) &#123;</span><br><span class="line">			sb.append(<span class="string">"&lt;"</span> + entry.getKey() + <span class="string">"&gt;"</span>);</span><br><span class="line">			sb.append(entry.getValue());</span><br><span class="line">			sb.append(<span class="string">"&lt;/"</span> + entry.getKey() + <span class="string">"&gt;"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		sb.append(<span class="string">"&lt;/xml&gt;"</span>);</span><br><span class="line">		System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;xml&gt;"</span> + sb.toString());</span><br><span class="line">		<span class="keyword">return</span> sb.toString();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><strong><strong>统一下单网络请求，用的HttpURLConnection请求，放在异步线程（官方给的demo用的是httpclient）</strong></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">placeArder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 创建url资源</span></span><br><span class="line">			URL url = <span class="keyword">new</span> URL(<span class="string">"https://api.mch.weixin.qq.com/pay/unifiedorder"</span>);<span class="comment">// 统一下单接口</span></span><br><span class="line">																				<span class="comment">// 微信的</span></span><br><span class="line">			<span class="comment">// 建立http连接</span></span><br><span class="line">			HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">			<span class="comment">// 设置允许输出</span></span><br><span class="line">			conn.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">			conn.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">			<span class="comment">// 设置不用缓存</span></span><br><span class="line">			conn.setUseCaches(<span class="keyword">false</span>);</span><br><span class="line">			<span class="comment">// 设置传递方式</span></span><br><span class="line">			conn.setRequestMethod(<span class="string">"POST"</span>);</span><br><span class="line">			<span class="comment">// 设置维持长连接</span></span><br><span class="line">			conn.setRequestProperty(<span class="string">"Connection"</span>, <span class="string">"Keep-Alive"</span>);</span><br><span class="line">			<span class="comment">// 设置文件字符集:</span></span><br><span class="line">			conn.setRequestProperty(<span class="string">"Charset"</span>, <span class="string">"UTF-8"</span>);</span><br><span class="line">			<span class="comment">// 转换为字节数组</span></span><br><span class="line">			<span class="keyword">byte</span>[] data = xmlString.getBytes();</span><br><span class="line">			<span class="comment">// 设置文件长度</span></span><br><span class="line">			conn.setRequestProperty(<span class="string">"Content-Length"</span>, String.valueOf(data.length));</span><br><span class="line">			<span class="comment">// 设置文件类型:</span></span><br><span class="line">			conn.setRequestProperty(<span class="string">"contentType"</span>, <span class="string">"text/xml"</span>);</span><br><span class="line">			<span class="comment">// 开始连接请求</span></span><br><span class="line">			conn.connect();</span><br><span class="line">			OutputStream out = conn.getOutputStream();</span><br><span class="line">			<span class="comment">// 写入请求的字符串</span></span><br><span class="line">			out.write(data);</span><br><span class="line">			out.flush();</span><br><span class="line">			out.close();</span><br><span class="line">			System.out.println(conn.getResponseCode());</span><br><span class="line">			<span class="comment">// 请求返回的状态</span></span><br><span class="line">			<span class="keyword">if</span> (conn.getResponseCode() == <span class="number">200</span>) &#123;</span><br><span class="line">				System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;连接成功"</span>);</span><br><span class="line">				<span class="comment">// 请求返回的数据</span></span><br><span class="line">				InputStream in = conn.getInputStream();</span><br><span class="line">				String a = <span class="keyword">null</span>;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">byte</span>[] data1 = <span class="keyword">new</span> <span class="keyword">byte</span>[in.available()];</span><br><span class="line">					in.read(data1);</span><br><span class="line">					<span class="comment">// 转成字符串</span></span><br><span class="line">					a = <span class="keyword">new</span> String(data1);</span><br><span class="line">					System.out.println(<span class="string">"&gt;&gt;&gt;&gt;a&gt;"</span> + a);</span><br><span class="line">					<span class="keyword">return</span> decodeXml(a);<span class="comment">//把返回的xml字符串转化成map对象</span></span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">					<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">					e1.printStackTrace();</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				System.out.println(<span class="string">"no++"</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><strong><strong>下面是统一下单接口返回的xml参数转化成map储存</strong></strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">decodeXml</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Map&lt;String, String&gt; xml = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">			XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">			parser.setInput(<span class="keyword">new</span> StringReader(content));</span><br><span class="line">			<span class="keyword">int</span> event = parser.getEventType();</span><br><span class="line">			<span class="keyword">while</span> (event != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line"></span><br><span class="line">				String nodeName = parser.getName();</span><br><span class="line">				<span class="keyword">switch</span> (event) &#123;</span><br><span class="line">				<span class="keyword">case</span> XmlPullParser.START_DOCUMENT:</span><br><span class="line"></span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> XmlPullParser.START_TAG:</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (<span class="string">"xml"</span>.equals(nodeName) == <span class="keyword">false</span>) &#123;</span><br><span class="line">						<span class="comment">// 实例化student对象</span></span><br><span class="line">						xml.put(nodeName, parser.nextText());</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> XmlPullParser.END_TAG:</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				event = parser.next();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> xml;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			Log.e(<span class="string">"orion-e---&gt;"</span>, e.toString());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong><strong>下面随机数生成代码</strong></strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取OutTradNo可根据用户自行更改 商户系统内部订单号，要求32个字符内、且在同一个商户号下唯一</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">genOutTradNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Random random = <span class="keyword">new</span> Random();</span><br><span class="line">		<span class="keyword">int</span> time = (<span class="keyword">int</span>) System.currentTimeMillis();</span><br><span class="line">		<span class="keyword">return</span> MD5.getMessageDigest(String.valueOf(random.nextInt(<span class="number">10000</span>) + time).getBytes());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong><strong>最后贴出MD5的类</strong></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MD5</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">MD5</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String <span class="title">getMessageDigest</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">char</span> hexDigits[] = &#123; <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span> &#125;;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			MessageDigest mdTemp = MessageDigest.getInstance(<span class="string">"MD5"</span>);</span><br><span class="line">			mdTemp.update(buffer);</span><br><span class="line">			<span class="keyword">byte</span>[] md = mdTemp.digest();</span><br><span class="line">			<span class="keyword">int</span> j = md.length;</span><br><span class="line">			<span class="keyword">char</span> str[] = <span class="keyword">new</span> <span class="keyword">char</span>[j * <span class="number">2</span>];</span><br><span class="line">			<span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; j; i++) &#123;</span><br><span class="line">				<span class="keyword">byte</span> byte0 = md[i];</span><br><span class="line">				str[k++] = hexDigits[byte0 &gt;&gt;&gt; <span class="number">4</span> &amp; <span class="number">0xf</span>];</span><br><span class="line">				str[k++] = hexDigits[byte0 &amp; <span class="number">0xf</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> String(str);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>至此微信支付的统一下单接口已近完成，具体的中间出现的错误码查看微信统一下单返回<a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_1" target="_blank" rel="noopener">错误码</a>，页面最下面。android如果统一下单成功后，项目集成了微信支付的SDK,开放平台设置的签名和包名正确的话，用如下代码就可以<a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_12&amp;index=2" target="_blank" rel="noopener">调起微信</a>支付了
</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*调起微信支付还需要的重新签名</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">msgApi = WXAPIFactory.createWXAPI(context, <span class="keyword">null</span>);</span><br><span class="line">		req = <span class="keyword">new</span> PayReq();</span><br><span class="line">		req.appId = <span class="string">"APP_ID"</span>;</span><br><span class="line">		req.partnerId = <span class="string">"MCH_ID"</span>;</span><br><span class="line">		req.prepayId = placeArder().get(<span class="string">"prepay_id"</span>);</span><br><span class="line">		req.packageValue = <span class="string">"Sign=WXPay"</span>;</span><br><span class="line">		req.nonceStr = genOutTradNo();</span><br><span class="line">		req.timeStamp = String.valueOf(System.currentTimeMillis() / <span class="number">1000</span>);</span><br><span class="line">		Map&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">		map.put(<span class="string">"appid"</span>, req.appId));</span><br><span class="line">		map.put(<span class="string">"noncestr"</span>, req.nonceStr));</span><br><span class="line">		map.put(<span class="string">"package"</span>, req.packageValue));</span><br><span class="line">		map.put(<span class="string">"partnerid"</span>, req.partnerId));</span><br><span class="line">		map.put(<span class="string">"prepayid"</span>, req.prepayId));</span><br><span class="line">		map.put(<span class="string">"timestamp"</span>, req.timeStamp));</span><br><span class="line">		req.sign = getSign(map);</span><br><span class="line">		msgApi.registerApp(<span class="string">"APP_ID"</span>);</span><br><span class="line">		msgApi.sendReq(req);</span><br></pre></td></tr></table></figure>
<p>到此android微信集成就完成了。。。在此记录一下  </p>
</div><div class="article-meta" style="max-width:800px"></div><div class="article-comment" style="max-width:800px"><div class="ds-thread" id="ds-thread" data-thread-key="cje11rvdj0000l8wqi0ba26w5" data-title="" data-url="http://www.hecl.club/2018/02/24/Android-集成微信支付流程和统一下单接口的调用/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/BoizZ" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://weibo.com/heqibang" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li><li><a href="https://www.segmentfault.com/u/bon" title="SegmentFault" target="_blank"><i class="icon icon-segmentfault"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2018 阿龙的故事<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>